---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Slide {
  name: string;
  imagePath: string;
}

export interface Props {
  slides: Slide[];
  class?: string;
}

const { slides, class: className = "" } = Astro.props;
const swiperClass = `swiper w-full my-10 md:my-20 ${className}`.trim();

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{jpeg,jpg,png,gif}"
);

const resolvedSlides = slides.map((slide) => {
  if (!images[slide.imagePath]) {
    throw new Error(
      `"${slide.imagePath}" does not exist in glob: "/src/assets/**/*.{jpeg,jpg,png,gif}"`
    );
  }
  return {
    name: slide.name,
    image: images[slide.imagePath](),
  };
});
---

<div class={swiperClass} data-swiper="coverflow">
  <div class="swiper-wrapper space-x-3">
    {
      resolvedSlides.map((slide, index) => (
        <div class="swiper-slide" data-index={index}>
          <div class="relative overflow-hidden rounded-xl">
            <Image
              src={slide.image}
              alt={slide.name}
              width={320}
              height={320}
              class="size-full object-cover"
            />
            <div class="bg-[#d4ff80] px-6 py-2 text-center font-semibold text-sm whitespace-nowrap">
              {slide.name}
            </div>
          </div>
        </div>
      ))
    }
  </div>
  <div class="swiper-pagination"></div>
</div>

<style is:global>
  @import "swiper/css";
  @import "swiper/css/effect-coverflow";
  @import "swiper/css/pagination";

  .swiper-slide {
    background-position: center;
    background-size: cover;
    width: 350px;
    height: auto;
  }

  .swiper-slide img {
    display: block;
    width: 100%;
  }

  .swiper-pagination {
    position: relative;
    margin-top: 20px;
  }

  .swiper-pagination-bullet {
    background: #916a2a;
  }

  .swiper-pagination-bullet-active {
    background: #b79647;
  }
</style>

<script>
  import Swiper from "swiper";
  import { EffectCoverflow, Pagination } from "swiper/modules";

  function initCoverflowSwiper(container: HTMLElement) {
    const slides = container.querySelectorAll(".swiper-slide");
    const totalSlides = slides.length;
    const centerIndex = Math.floor(totalSlides / 2);

    const isMobile = window.innerWidth < 768;

    if (isMobile) {
      new Swiper(container, {
        modules: [Pagination],
        grabCursor: true,
        centeredSlides: false,
        slidesPerView: 2,
        freemode: true,
        initialSlide: 0,
        pagination: {
          el: ".swiper-pagination",
          clickable: true,
        },
      });
    } else {
      new Swiper(container, {
        modules: [EffectCoverflow],
        effect: "coverflow",
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: "auto",
        spaceBetween: 15,
        initialSlide: centerIndex,
        coverflowEffect: {
          rotate: 0,
          stretch: 0,
          depth: 100,
          modifier: 3,
          slideShadows: false,
        },
        pagination: {
          el: ".swiper-pagination",
          clickable: true,
        },
      });
    }
  }

  function initAllSwipers() {
    const swipers = document.querySelectorAll(".swiper[data-swiper=\"coverflow\"]");
    swipers.forEach((swiper) => {
      if (swiper.classList.contains("swiper-initialized")) return;
      initCoverflowSwiper(swiper as HTMLElement);
    });
  }

  initAllSwipers();

  document.addEventListener("astro:after-swap", () => {
    initAllSwipers();
  });
</script>
